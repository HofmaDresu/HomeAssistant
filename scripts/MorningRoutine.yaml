alias: Morning Routine
sequence:
  - variables:
      today:
        year: "{{now().year}}"
        month: "{{now().month}}"
        day: "{{now().day}}"
        weekday: "{{now().weekday()}}"
      tomorrow:
        year: "{{(now() + timedelta(days=1)).year}}"
        month: "{{(now() + timedelta(days=1)).month}}"
        day: "{{(now() + timedelta(days=1)).day}}"
        weekday: "{{(now() + timedelta(days=1)).weekday()}}"
      target: "{{tomorrow if now().hour >= 7 else today}}"
      targetIsToday: "{{today.day == target.day}}"
      targetSevenAmString: "{{target.year}}:{{target.month}}:{{target.day}}:7"
      targetSevenAm: "{{strptime(targetSevenAmString, '%Y:%m:%d:%H')}}"
      targetSevenAmTimestamp: "{{strptime(targetSevenAmString, '%Y:%m:%d:%H').timestamp()}}"
      targetEightAmString: "{{target.year}}:{{target.month}}:{{target.day}}:8"
      targetEightAm: "{{strptime(targetEightAmString, '%Y:%m:%d:%H')}}"
      targetEightAmTimestamp: "{{strptime(targetEightAmString, '%Y:%m:%d:%H').timestamp()}}"
      targetNineAmString: "{{target.year}}:{{target.month}}:{{target.day}}:9"
      targetNineAm: "{{strptime(targetNineAmString, '%Y:%m:%d:%H')}}"
      targetNineAmTimestamp: "{{strptime(targetNineAmString, '%Y:%m:%d:%H').timestamp()}}"
      eightHours: "{{8 * 60 * 60}}"
      timeToSevenAm: "{{targetSevenAmTimestamp - now().timestamp()}}"
      timeToEightAm: "{{targetEightAmTimestamp - now().timestamp()}}"
      weekdayFireAlarmAt: "{{targetSevenAm if timeToSevenAm >= eightHours else targetEightAm}}"
      weekendFireAlarmAt: "{{targetEightAm if timeToEightAm >= eightHours else targetNineAm}}"
      targetIsWeekend: "{{target.weekday == 5 or target.weekday == 6}}"
      targetIsTuesday: "{{target.weekday == 1}}"
  - variables:
      baseFireAlarmAt: "{{weekendFireAlarmAt if targetIsWeekend else weekdayFireAlarmAt}}"
      fireAlarmAt: "{{targetSevenAm if targetIsTuesday else baseFireAlarmAt}}"
      fireAlarmIn: >-
        {{strptime(fireAlarmAt, '%Y-%m-%d %H:%M:%S').timestamp() -
        now().timestamp()}}
    enabled: true
  - service: tts.cloud_say
    data:
      cache: false
      entity_id: media_player.bedroom_speaker
      message: >-
        Goodnight Matt. Your alarm is set to {{'today' if targetIsToday else
        'tomorrow'}} at {{strptime(fireAlarmAt, '%Y-%m-%d
        %H:%M:%S').hour}}:{{strptime(fireAlarmAt, '%Y-%m-%d %H:%M:%S').minute}}
    enabled: true
  - delay: "{{fireAlarmIn}}"
    enabled: true
  - alias: Stop if circuitbreaker
    if:
      - condition: state
        entity_id: input_boolean.alarm_circuitbreaker
        state: "on"
    then:
      - stop: Circuit Breaker
    enabled: false
  - alias: Stop if already awake
    if:
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.pixel_8_battery_state
            state: charging
        alias: Phone not charging
    then:
      - stop: Already awake
    enabled: false
  - parallel:
      - if:
          - condition: template
            value_template: "{{true}}"
        then:
          - delay:
              hours: 0
              minutes: 0
              seconds: 10
              milliseconds: 0
          - type: turn_on
            device_id: d4b4dce9f0f3fcdf3e769a70ff259468
            entity_id: 89d5346579b899623f4d4f45014c604a
            domain: switch
        alias: Turn on light with delay
      - alias: Trigger Alarm
        if:
          - condition: template
            value_template: "{{tomorrowIsWeekend}}"
        then:
          - service: media_player.volume_set
            target:
              device_id: 9fc03fd71134e36fcd2978f851022652
            data:
              volume_level: 0.6
          - service: media_player.play_media
            target:
              entity_id: media_player.bedroom_speaker
            data:
              media_content_id: media-source://media_source/local/25 Salvation is Created.mp3
              media_content_type: audio/mpeg
            metadata:
              title: 25 Salvation is Created.mp3
              thumbnail: null
              media_class: music
              children_media_class: null
              navigateIds:
                - {}
                - media_content_type: app
                  media_content_id: media-source://media_source
          - delay:
              hours: 0
              minutes: 2
              seconds: 2
              milliseconds: 0
          - service: media_player.volume_set
            target:
              device_id: 9fc03fd71134e36fcd2978f851022652
            data:
              volume_level: 0.3
        else:
          - service: media_player.volume_set
            target:
              device_id: 9fc03fd71134e36fcd2978f851022652
            data:
              volume_level: 0.6
          - service: media_player.play_media
            target:
              entity_id: media_player.bedroom_speaker
            data:
              media_content_id: media-source://media_source/local/01 Entry Cadence.mp3
              media_content_type: audio/mpeg
            metadata:
              title: 01 Entry Cadence.mp3
              thumbnail: null
              media_class: music
              children_media_class: null
              navigateIds:
                - {}
                - media_content_type: app
                  media_content_id: media-source://media_source
          - delay:
              hours: 0
              minutes: 0
              seconds: 42
              milliseconds: 0
          - service: media_player.play_media
            target:
              entity_id: media_player.bedroom_speaker
            data:
              media_content_id: media-source://media_source/local/02 M Fanfare.mp3
              media_content_type: audio/mpeg
            metadata:
              title: 02 M Fanfare.mp3
              thumbnail: null
              media_class: music
              children_media_class: null
              navigateIds:
                - {}
                - media_content_type: app
                  media_content_id: media-source://media_source
          - delay:
              hours: 0
              minutes: 0
              seconds: 54
              milliseconds: 0
          - service: media_player.volume_set
            target:
              device_id: 9fc03fd71134e36fcd2978f851022652
            data:
              volume_level: 0.3
    enabled: true
  - delay:
      hours: 0
      minutes: 40
      seconds: 0
      milliseconds: 0
  - if:
      - condition: and
        conditions:
          - condition: time
            weekday:
              - fri
              - thu
              - wed
              - tue
              - mon
          - condition: device
            device_id: 6dbdf144428b850689a68b1c6b7b19de
            domain: device_tracker
            entity_id: d366159c7cf8e5ec7b73b94ca8db9a81
            type: is_home
        alias: Home on weekday
    then:
      - type: turn_on
        device_id: bad671e7062197c2244063c9ab807b41
        entity_id: 570122fb667e2bbf465c4b1eee4cc5b8
        domain: light
      - type: turn_on
        device_id: 1155e017f2b58ecdf76d69807001a0b9
        entity_id: 525207ce60b068d636526e83f993b12a
        domain: light
      - type: turn_off
        device_id: 53c67fc630ffb53184d225bbfc7c2fa8
        entity_id: df93ec8a60392af9342a2076858609f2
        domain: light
    alias: Turn on office if home on weekday
mode: single
