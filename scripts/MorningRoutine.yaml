alias: Morning Routine
sequence:
  - variables:
      today:
        year: "{{now().year}}"
        month: "{{now().month}}"
        day: "{{now().day}}"
        weekday: "{{now().weekday()}}"
      tomorrow:
        year: "{{(now() + timedelta(days=1)).year}}"
        month: "{{(now() + timedelta(days=1)).month}}"
        day: "{{(now() + timedelta(days=1)).day}}"
        weekday: "{{(now() + timedelta(days=1)).weekday()}}"
      target: "{{tomorrow if now().hour >= 7 else today}}"
      targetIsToday: "{{today.day == target.day}}"
      targetSevenAmString: "{{target.year}}:{{target.month}}:{{target.day}}:7"
      targetSevenAm: "{{strptime(targetSevenAmString, '%Y:%m:%d:%H')}}"
      targetSevenAmTimestamp: "{{strptime(targetSevenAmString, '%Y:%m:%d:%H').timestamp()}}"
      targetEightAmString: "{{target.year}}:{{target.month}}:{{target.day}}:8"
      targetEightAm: "{{strptime(targetEightAmString, '%Y:%m:%d:%H')}}"
      targetEightAmTimestamp: "{{strptime(targetEightAmString, '%Y:%m:%d:%H').timestamp()}}"
      targetNineAmString: "{{target.year}}:{{target.month}}:{{target.day}}:9"
      targetNineAm: "{{strptime(targetNineAmString, '%Y:%m:%d:%H')}}"
      overrideString: >-
        {{target.year}}:{{target.month}}:{{target.day}}:{{strptime(states('input_datetime.alarm_override_time'),
        '%H:%M:%S').hour}}:{{strptime(states('input_datetime.alarm_override_time'),
        '%H:%M:%S').minute}}
      overrideAt: "{{strptime(overrideString, '%Y:%m:%d:%H:%M')}}"
      eightHours: "{{8 * 60 * 60}}"
      timeToSevenAm: "{{targetSevenAmTimestamp - now().timestamp()}}"
      timeToEightAm: "{{targetEightAmTimestamp - now().timestamp()}}"
      weekdayFireAlarmAt: "{{targetSevenAm if timeToSevenAm >= eightHours else targetEightAm}}"
      weekendFireAlarmAt: "{{targetEightAm if timeToEightAm >= eightHours else targetNineAm}}"
      targetIsWeekend: "{{target.weekday == 5 or target.weekday == 6}}"
      targetIsTuesday: "{{target.weekday == 1}}"
      isPetMode: "{{states('input_boolean.pet_mode') == 'on'}}"
  - variables:
      baseFireAlarmAt: "{{weekendFireAlarmAt if targetIsWeekend else weekdayFireAlarmAt}}"
      calculatedFireAlarmAt: "{{targetSevenAm if targetIsTuesday or isPetMode else baseFireAlarmAt}}"
      isOverrideActive: "{{states('input_boolean.alarm_override_active') == 'on'}}"
      fireAlarmAt: "{{overrideAt if isOverrideActive else calculatedFireAlarmAt}}"
      fireAlarmIn: >-
        {{strptime(fireAlarmAt, '%Y-%m-%d %H:%M:%S').timestamp() -
        now().timestamp()}}
    enabled: true
  - if: []
    then:
      - service: tts.cloud_say
        data:
          cache: false
          entity_id: media_player.living_room_home
          message: >-
            Goodnight Matt. {{overrideString}} Your alarm is set to {{'today' if
            targetIsToday else 'tomorrow'}} at {{strptime(fireAlarmAt, '%Y-%m-%d
            %H:%M:%S').hour}}:{{strptime(fireAlarmAt, '%Y-%m-%d
            %H:%M:%S').minute}}
        enabled: false
      - service: logbook.log
        metadata: {}
        data:
          name: morning_routine_testing
          message: >-
            "Goodnight Matt. Your alarm is set to {{'today' if targetIsToday
            else     'tomorrow'}} at {{strptime(fireAlarmAt, '%Y-%m-%d    
            %H:%M:%S').hour}}:{{strptime(fireAlarmAt, '%Y-%m-%d
            %H:%M:%S').minute}}"
      - stop: ""
    alias: Test logging (halts)
    enabled: false
  - service: tts.cloud_say
    data:
      cache: false
      entity_id: media_player.bedroom_speaker
      message: >-
        Goodnight Matt. Your alarm is set to {{'today' if targetIsToday else
        'tomorrow'}} at {{strptime(fireAlarmAt, '%Y-%m-%d
        %H:%M:%S').hour}}:{{strptime(fireAlarmAt, '%Y-%m-%d %H:%M:%S').minute}}
    enabled: true
  - delay: "{{fireAlarmIn}}"
    enabled: true
  - alias: Stop if circuitbreaker
    if:
      - condition: state
        entity_id: input_boolean.alarm_circuitbreaker
        state: "on"
    then:
      - stop: Circuit Breaker
    enabled: true
  - service: alarm_control_panel.alarm_disarm
    metadata: {}
    data:
      code: ""
    target:
      device_id: 12991409e93a14125e39db65a3b740dc
  - alias: Stop if already awake
    if:
      - condition: state
        entity_id: sensor.pixel_8_battery_state
        state: discharging
    then:
      - stop: Already awake
    enabled: true
  - parallel:
      - if:
          - condition: template
            value_template: "{{true}}"
        then:
          - delay:
              hours: 0
              minutes: 0
              seconds: 10
              milliseconds: 0
          - type: turn_on
            device_id: d4b4dce9f0f3fcdf3e769a70ff259468
            entity_id: 89d5346579b899623f4d4f45014c604a
            domain: switch
        alias: Turn on light with delay
      - alias: Trigger Alarm
        if:
          - condition: template
            value_template: "{{targetIsWeekend}}"
        then:
          - service: media_player.volume_set
            target:
              device_id: 9fc03fd71134e36fcd2978f851022652
            data:
              volume_level: 0.6
          - service: media_player.play_media
            target:
              entity_id: media_player.bedroom_speaker
            data:
              media_content_id: media-source://media_source/local/25 Salvation is Created.mp3
              media_content_type: audio/mpeg
            metadata:
              title: 25 Salvation is Created.mp3
              thumbnail: null
              media_class: music
              children_media_class: null
              navigateIds:
                - {}
                - media_content_type: app
                  media_content_id: media-source://media_source
          - delay:
              hours: 0
              minutes: 2
              seconds: 2
              milliseconds: 0
          - service: media_player.volume_set
            target:
              device_id: 9fc03fd71134e36fcd2978f851022652
            data:
              volume_level: 0.3
        else:
          - service: media_player.volume_set
            target:
              device_id: 9fc03fd71134e36fcd2978f851022652
            data:
              volume_level: 0.6
          - service: media_player.play_media
            target:
              entity_id: media_player.bedroom_speaker
            data:
              media_content_id: media-source://media_source/local/01 Entry Cadence.mp3
              media_content_type: audio/mpeg
            metadata:
              title: 01 Entry Cadence.mp3
              thumbnail: null
              media_class: music
              children_media_class: null
              navigateIds:
                - {}
                - media_content_type: app
                  media_content_id: media-source://media_source
          - delay:
              hours: 0
              minutes: 0
              seconds: 42
              milliseconds: 0
          - service: media_player.play_media
            target:
              entity_id: media_player.bedroom_speaker
            data:
              media_content_id: media-source://media_source/local/02 M Fanfare.mp3
              media_content_type: audio/mpeg
            metadata:
              title: 02 M Fanfare.mp3
              thumbnail: null
              media_class: music
              children_media_class: null
              navigateIds:
                - {}
                - media_content_type: app
                  media_content_id: media-source://media_source
          - delay:
              hours: 0
              minutes: 0
              seconds: 54
              milliseconds: 0
          - service: media_player.volume_set
            target:
              device_id: 9fc03fd71134e36fcd2978f851022652
            data:
              volume_level: 0.3
    enabled: true
mode: single
